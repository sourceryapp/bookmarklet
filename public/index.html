<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sourcery Bookmarklet</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/style.css">
</head>

<body>
    <main>

        <div id="app">

            <form class="form-signin" autocomplete="off" @submit.prevent="testBookmarklet()">

                <h1 class="h3 mb-3 font-weight-normal">Sourcery Bookmarklet Testing Tool</h1>

                <div class="mb-4">
                    <label for="endpoint">Bookmarklet Endpoint</label>
                    <select class="form-select" aria-label="Bookmarklet Endpoint" v-model="endpoint" @change="updateCode">
                        <option :value="config.dev_endpoint" selected>Use Development Server (local)</option>
                        <option :value="config.prod_endpoint">Use Production Server (Supabase)</option>
                    </select>
                    <div class="form-text">{{endpoint}}</div>
                </div>

                <div class="mb-4">

                    <label for="source_url" class="">Source/Citation URL</label>
                    <input type="url" v-model="source_url" id="source_url" class="form-control" placeholder="Source URL" @keyup="updateCode"
                        required>
                </div>


                <button class="btn btn-lg btn-primary btn-block" type="submit">Test It!</button>

                <!-- Button trigger modal -->
                <button type="button" class="btn btn-lg btn-outline-secondary ms-3" data-bs-toggle="modal" data-bs-target="#exampleModal">
                    View Code
                </button>
                
                <!-- Modal -->
                <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h1 class="modal-title fs-5" id="exampleModalLabel">Bookmarklet Code</h1>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <ul class="nav nav-tabs">
                                    <li class="nav-item">
                                        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#code" type="button" role="tab" aria-controls="home-tab-pane" aria-selected="true">Code</button>
                                    </li>
                                    <li class="nav-item">
                                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#minified" type="button" role="tab" aria-controls="profile-tab-pane" aria-selected="false">Minified</button>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#">Link</a>
                                    </li>
                                </ul>
                                <div class="tab-content" id="myTabContent">
                                    <div id="code" class="tab-pane fade show active m-3"><pre><code>{{ code?.testCode }}</code></pre></div>
                                    <div id="minified" class="tab-pane fade m-3"><pre><code>{{ code?.asLinkMin }}</code></pre></div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

                
                <!-- <pre><code>{{ code?.asLinkMin }}</code></pre> -->

            </form>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
        <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
        <script type="module">
            import config from './js/config.js'
            import bookmarklet_code from './js/bookmarklet.js'
            const { createApp } = Vue


            
            createApp({
                data() {
                    return {

                        // App Config
                        config,

                        // Default to dev endpoint
                        endpoint: config.dev_endpoint,
                        // Sample Source URL
                        source_url: 'https://www.nytimes.com/2018/06/11/technology/net-neutrality-repeal.html',

                        // Bookmarklet Code (Object)
                        code: {}
                    }
                },
                methods: {

                    // Method to open the bookmarklet
                    testBookmarklet() {
                        console.log('running code')
                        eval(this.code.testCode)
                    },
                    async transformBookmarkletCode(data) {
                        let codeAsString = data.toString().trim()
                        return {
                            // Original Code
                            initial: data,

                            // Code as String
                            asString: codeAsString,

                            // Code as Link
                            asLink: `javascript:(${codeAsString})('${config.prod_endpoint}','${window.location.href}')`,
                            
                            // Code as Minified Link (for production use)
                            asLinkMin: 'javascript:' + await this.minify(`(${codeAsString})('${config.prod_endpoint}',window.location.href)`),
                            
                            // Code, eval'able for testing
                            testCode: `(${codeAsString})('${this.endpoint}', '${this.source_url}')`
                        }
                    },
                    async updateCode() {
                        console.log('updating code')
                        this.code = await this.transformBookmarkletCode(bookmarklet_code)
                        console.log(this.code.testCode)
                    },
                    async minify(js) {
                        let minified = ''
                        try {
                            let response = await fetch('/api/minify', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'text/plain'
                                },
                                body: js
                            });
                            minified = await response.text();
                        } catch (error) {
                            console.error('Error:', error)
                        }  
                        return minified                  
                    }

                },
                mounted() {
                    console.log('Endpoint', this.endpoint)
                    this.updateCode()
                    console.log('Endpoint', this.endpoint)

                }

            }).mount('#app')     
            
            // function isDev(){
            //     const current_url = new URL(window.location.href)
            //     return (current_url.hostname == 'localhost' || current_url.hostname == '127.0.0.1')
            // }
    
        </script>

    </main>
</body>

</html>